<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>encoder.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.11.1 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; </center>
<hr><h1>encoder.h</h1><div class="fragment"><pre>00001 <font class="comment">/*--License:</font>
00002 <font class="comment">        Kyra Sprite Engine</font>
00003 <font class="comment">        Copyright Lee Thomason (Grinning Lizard Software) 2001-2002</font>
00004 <font class="comment">        www.grinninglizard.com/kyra</font>
00005 <font class="comment">        www.sourceforge.net/projects/kyra</font>
00006 <font class="comment"></font>
00007 <font class="comment">        Kyra is provided under 2 licenses:</font>
00008 <font class="comment"></font>
00009 <font class="comment">        - The GPL, with no additional restrictions.</font>
00010 <font class="comment">        - The LGPL, provided you display the Kyra splash screen, described below.</font>
00011 <font class="comment"></font>
00012 <font class="comment"></font>
00013 <font class="comment">--- GPL License --</font>
00014 <font class="comment">        This program is free software; you can redistribute it and/or</font>
00015 <font class="comment">        modify it under the terms of the GNU General Public License</font>
00016 <font class="comment">        as published by the Free Software Foundation; either version 2</font>
00017 <font class="comment">        of the License, or (at your option) any later version.</font>
00018 <font class="comment"></font>
00019 <font class="comment">        This program is distributed in the hope that it will be useful,</font>
00020 <font class="comment">        but WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00021 <font class="comment">        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</font>
00022 <font class="comment">        GNU General Public License for more details.</font>
00023 <font class="comment"></font>
00024 <font class="comment">        You should have received a copy of the GNU General Public License</font>
00025 <font class="comment">        along with this program; if not, write to the Free Software</font>
00026 <font class="comment">        Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</font>
00027 <font class="comment"></font>
00028 <font class="comment">        The full text of the license can be found in license.txt</font>
00029 <font class="comment"></font>
00030 <font class="comment"></font>
00031 <font class="comment">--- LGPL License --</font>
00032 <font class="comment">  **Provided you kindly display the Kyra splash screen (details below), </font>
00033 <font class="comment">        you     may use the LGPL license:**</font>
00034 <font class="comment"></font>
00035 <font class="comment">    This library is free software; you can redistribute it and/or</font>
00036 <font class="comment">    modify it under the terms of the GNU Lesser General Public</font>
00037 <font class="comment">    License as published by the Free Software Foundation; either</font>
00038 <font class="comment">    version 2.1 of the License, or (at your option) any later version.</font>
00039 <font class="comment"></font>
00040 <font class="comment">    This library is distributed in the hope that it will be useful,</font>
00041 <font class="comment">    but WITHOUT ANY WARRANTY; without even the implied warranty of</font>
00042 <font class="comment">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</font>
00043 <font class="comment">    Lesser General Public License for more details.</font>
00044 <font class="comment"></font>
00045 <font class="comment">    You should have received a copy of the GNU Lesser General Public</font>
00046 <font class="comment">    License along with this library; if not, write to the Free Software</font>
00047 <font class="comment">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</font>
00048 <font class="comment"></font>
00049 <font class="comment">        The full text of the license can be found in lgpl.txt</font>
00050 <font class="comment"></font>
00051 <font class="comment"></font>
00052 <font class="comment">--- Kyra Splash Screen.</font>
00053 <font class="comment"></font>
00054 <font class="comment">        It would be appreciate if you display the Kyra splash screen when using</font>
00055 <font class="comment">        either license, however it is only required for the LGPL. All the</font>
00056 <font class="comment">        resources for the splash are compiled into the library, and it can be</font>
00057 <font class="comment">        accessed through the following API:</font>
00058 <font class="comment"></font>
00059 <font class="comment">                KrEngine::StartSplash</font>
00060 <font class="comment">                KrEngine::UpdateSplash</font>
00061 <font class="comment">                KrEngine::EndSplash</font>
00062 <font class="comment"></font>
00063 <font class="comment">        Full documentation is provided with the KrEngine class. The splash screen</font>
00064 <font class="comment">        should be displayed for 2 seconds.</font>
00065 <font class="comment"></font>
00066 <font class="comment">        Thank you.</font>
00067 <font class="comment">*/</font>
00068 
00069 <font class="preprocessor">#ifndef ENCODER_INCLUDED</font>
00070 <font class="preprocessor"></font><font class="preprocessor">#define ENCODER_INCLUDED</font>
00071 <font class="preprocessor"></font>
00072 <font class="preprocessor">#include "SDL.h"</font>
00073 <font class="preprocessor">#include "../tinyxml/tinyxml.h"</font>
00074 <font class="preprocessor">#include "../util/gltypes.h"</font>
00075 <font class="preprocessor">#include "../engine/color.h"</font>
00076 <font class="preprocessor">#include "../util/gllist.h"</font>
00077 <font class="preprocessor">#include "kyraresource.h"</font>
00078 <font class="preprocessor">#include "namefield.h"</font>
00079 <font class="preprocessor">#include "vault.h"</font>
00080 
00081 
00082 <font class="keyword">class </font>KrRle;
00083 <font class="keyword">class </font><a class="code" href="classKrCanvasResource.html">KrCanvasResource</a>;
00084 <font class="keyword">class </font>KrPixelBlock;
00085 <font class="keyword">class </font>KrCachedWrite;
00086 <font class="keyword">class </font><a class="code" href="classKrConsole.html">KrConsole</a>;
00087 <font class="keyword">class </font><a class="code" href="classKrEngine.html">KrEngine</a>;
00088 
00089 
00090 <font class="keyword">typedef</font> SDL_Surface* (*ImageLoaderFunc)( <font class="keyword">const</font> <font class="keywordtype">char</font>* );
00091 
00092 
00093 <font class="keyword">class </font>KrEncoder
00094 {
00095   <font class="keyword">public</font>:
00096         KrEncoder( SDL_RWops* stream );
00097 
00098         <font class="comment">// Writes the header of the .dat file.</font>
00099         <font class="keywordtype">bool</font> StartDat();
00100 
00101         <font class="comment">/*      Process an entire doc, write the result of the</font>
00102 <font class="comment">                encoding to stream. Normally called between a</font>
00103 <font class="comment">                'StartDat' and 'EndDat'. If the 'screen' is non-0</font>
00104 <font class="comment">                then the surface will be displayed as we go.</font>
00105 <font class="comment">        */</font>
00106         <font class="keywordtype">bool</font> ProcessDoc( <font class="keyword">const</font> TiXmlDocument&amp; doc, 
00107                                          <a class="code" href="classKrEngine.html">KrEngine</a>*  engine,
00108                                          <a class="code" href="classKrConsole.html">KrConsole</a>* output );
00109 
00110         <font class="comment">// Writes the tail of the .dat and completes the header.</font>
00111         <font class="keywordtype">bool</font> EndDat();
00112 
00113         <font class="keywordtype">void</font> WriteHeader( <font class="keyword">const</font> <font class="keywordtype">char</font>* name, 
00114                                           FILE* stream,
00115                                           <font class="keyword">const</font> <font class="keywordtype">char</font>* prefix );
00116 
00117         <font class="comment">/*  A utility function that loads a surface. Will be converted</font>
00118 <font class="comment">                to 32 bit regardless of the source format.</font>
00119 <font class="comment"></font>
00120 <font class="comment">                @param filename         The filename of the surface to load.</font>
00121 <font class="comment">                @param transparent      An array of colors that will be interpreted     </font>
00122 <font class="comment">                                                        as transparent. (Only used for surfaces</font>
00123 <font class="comment">                                                        less than 32 bit.)</font>
00124 <font class="comment">                @param nTransparent     The number of entries in the transparent array.</font>
00125 <font class="comment">                @param error            If an error occurs, the despcription will go here.</font>
00126 <font class="comment">        */</font>
00127         <font class="keyword">enum</font>
00128         {
00129                 RGBA,
00130                 UpperLeft,
00131                 LowerLeft,
00132                 UpperRight,
00133                 LowerRight
00134         };
00135 
00136         <font class="keyword">struct </font>Transparent
00137         {
00138                 <font class="keywordtype">int</font> type;                       <font class="comment">// one of the enums, above.</font>
00139                 <a class="code" href="unionKrRGBA.html">KrRGBA</a> rgba;            <font class="comment">// if RGBA, value is here.</font>
00140         };
00141 
00142         <font class="comment">/*      Very, very strange limitation. It is important to not link the engine</font>
00143 <font class="comment">                library with SDL_Image...because it doesn't use it. But static linking</font>
00144 <font class="comment">                is confusing the linker, so it looks for the unused IMG_Load function.</font>
00145 <font class="comment">                If a tool wishes to make that function available, its address is passed</font>
00146 <font class="comment">                here.</font>
00147 <font class="comment">        */</font>
00148         <font class="keyword">static</font> <font class="keywordtype">void</font> SetImageLoader( ImageLoaderFunc i )<font class="keyword">         </font>{ ImageLoader = i; }
00149 
00150         <font class="keyword">static</font> SDL_Surface* Load32Surface(      <font class="keyword">const</font> <font class="keywordtype">char</font>* filename,
00151                                                                                 Transparent* transparent,
00152                                                                                 <font class="keywordtype">int</font> nTransparent,
00153                                                                                 std::string* error );
00154 
00155         <font class="comment">/*  Exactly the same as Load32Surface, except that it loads to </font>
00156 <font class="comment">                a canvas. A transition function on the road to wrapping</font>
00157 <font class="comment">                the video layer.</font>
00158 <font class="comment">        */</font>
00159         <font class="keyword">static</font> <a class="code" href="classKrCanvasResource.html">KrCanvasResource</a>* Load32Canvas(  <font class="keyword">const</font> <font class="keywordtype">char</font>* filename,
00160                                                                                         <font class="keyword">const</font> <a class="code" href="unionKrRGBA.html">KrRGBA</a>* transparent,
00161                                                                                         <font class="keywordtype">int</font> nTransparent,
00162                                                                                         std::string* error );
00163 
00164         <font class="comment">/*  Useful, if odd, function to create a fixed font</font>
00165 <font class="comment">                from a BMP file in a buffer. It assumes</font>
00166 <font class="comment">                ascii: start 32, length 95.</font>
00167 <font class="comment">        */</font>
00168         <font class="keyword">static</font> <a class="code" href="classKrFontResource.html">KrFontResource</a>* CreateFixedFontResource( <font class="keyword">const</font> <font class="keywordtype">char</font>* resourceName,
00169                                                                                                         <font class="keyword">const</font> U8* buffer,
00170                                                                                                         <font class="keywordtype">int</font> bufferSize );
00171                                                                                                         
00172 
00173         <font class="comment">// Used by the tags to Save() themselves.</font>
00174         <font class="keywordtype">void</font> StartTag( U32 tag );
00175         <font class="keywordtype">void</font> EndTag();
00176         <font class="keywordtype">void</font> WriteCached( <font class="keyword">const</font> std::string&amp; name )<font class="keyword">             </font>{ cachedWrite.Write( name ); }
00177         SDL_RWops* Stream()<font class="keyword">                                                             </font>{ <font class="keywordflow">return</font> stream; }
00178         <font class="keywordtype">void</font> AddCount( U32 _numLines, U32 _numSegments, U32 _numRGBA )<font class="keyword">                                          </font>
00179 <font class="keyword">                                                                                                        </font>{       
00180                                                                                                                 GLASSERT( _numRGBA &gt;= _numSegments );
00181 <font class="comment">//                                                                                                              GLASSERT( _numSegments &gt;= _numLines );</font>
00182                                                                                                                 numLine         += _numLines;
00183                                                                                                                 numSegment      += _numSegments;
00184                                                                                                                 numRGBA         += _numRGBA;
00185                                                                                                                 GLASSERT( numRGBA &gt;= numSegment );
00186 <font class="comment">//                                                                                                              GLASSERT( numSegment &gt;= numLine );</font>
00187                                                                                                          }
00188         <font class="keywordtype">void</font> KrEncoder::Save();
00189 
00190         <a class="code" href="classKrResourceVault.html">KrResourceVault</a>* GetVault()<font class="keyword">                                             </font>{ <font class="keywordflow">return</font> &amp;vault; }
00191 
00192   <font class="keyword">private</font>:
00193         <font class="keyword">static</font> ImageLoaderFunc ImageLoader;
00194 
00195 <font class="comment">//      void InitOutput( SDL_Surface* screen );</font>
00196 
00197         <font class="keyword">enum</font>
00198         {
00199                 TYPE_NONE, 
00200                 TYPE_SPRITE, 
00201                 TYPE_TILE, 
00202                 TYPE_FONT
00203         };
00204 
00205         <font class="keyword">enum</font>
00206         {
00207                 SUBTYPE_FIXEDFONT,              <font class="comment">// The default value.</font>
00208                 SUBTYPE_SFONT,
00209         };
00210 
00211         <font class="keyword">struct </font>AllInfo
00212         {
00213                 AllInfo() :     type( 0 ),
00214                                         subType( 0 ),
00215                                         name( "NONE" ), action( "NONE" ), 
00216                                         useEntireImage( false ),
00217                                         frameCount( 0 ),
00218                                         x( 0 ), y( 0 ), 
00219                                         width( 0 ), height( 0 ), 
00220                                         <font class="comment">//hasHotspot( false ),</font>
00221                                         hotx( 0 ), hoty( 0 ),
00222                                         <font class="comment">//hasDelta( false ),</font>
00223                                         deltax( 0 ), deltay( 0 ),
00224                                         isoTargetWidth( 0 ),
00225                                         fontStart( 0 ),
00226                                         fontLength( 0 ),
00227                                         space( 0 )                      { keyColor.Set( 0, 0, 0, 0 ); }
00228 
00229                 <font class="keywordtype">int</font>                     type;                           <font class="comment">// SPRITE, TILE, ...</font>
00230                 <font class="keywordtype">int</font>                     subType;
00231                 <font class="comment">//std::string filename;                 // The filename that goes with this.</font>
00232                 std::string name;                               <font class="comment">// Sprite, Tile, Font, etc.</font>
00233                 std::string action;
00234                 <font class="comment">//int                   frame;                  // Automatically calculated</font>
00235                 <font class="keywordtype">bool</font>            useEntireImage;         <font class="comment">// If true, width, height, x, y don't matter</font>
00236                 <font class="keywordtype">int</font>                     frameCount;                     <font class="comment">// Limit for # frames to be read by color key</font>
00237                 <font class="keywordtype">int</font>                     x, y;
00238                 <font class="keywordtype">int</font>                     width, height;          <font class="comment">// Width and Height set for tiles</font>
00239                 <font class="keywordtype">int</font>                     hotx, hoty;
00240                 <font class="keywordtype">int</font>                     deltax, deltay;
00241                 <font class="keywordtype">int</font>                     isoTargetWidth;
00242                 <font class="keywordtype">int</font>                     fontStart;                      <font class="comment">// Glyph number that starts the font</font>
00243                 <font class="keywordtype">int</font>                     fontLength;
00244                 <font class="keywordtype">int</font>                     space;                          <font class="comment">// Space glyph number for a font</font>
00245                 <a class="code" href="unionKrRGBA.html">KrRGBA</a>          keyColor;                       <font class="comment">// Color key color, if used.</font>
00246                 <a class="code" href="classGlDynArray.html">GlDynArray&lt; int &gt;</a> rotation;             <font class="comment">// All the rotation angles specified.</font>
00247         };
00248         
00249         <font class="keywordtype">void</font> CalcAllInfo( TiXmlNode* node, AllInfo* info, SDL_Surface* );
00250 
00251         <font class="keywordtype">void</font> CreateIsoTile(     KrPaintInfo* info, 
00252                                                 <a class="code" href="classKrConsole.html">KrConsole</a>* console,
00253                                                 <font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y,
00254                                                 <font class="keywordtype">int</font> width, <font class="keywordtype">int</font> height,
00255                                                 KrRle* rle,
00256                                                 <font class="keywordtype">int</font> isoIdealWidth,
00257                                                 <font class="keywordtype">int</font> rotation );
00258 
00259         <font class="keywordtype">void</font> IsoToSource( <a class="code" href="classGlFixed.html">GlFixed</a> x, <a class="code" href="classGlFixed.html">GlFixed</a> y, <a class="code" href="classGlFixed.html">GlFixed</a> isoWidth, 
00260                                           <a class="code" href="classGlFixed.html">GlFixed</a> sourceW, <a class="code" href="classGlFixed.html">GlFixed</a>  sourceH,
00261                                           <a class="code" href="classGlFixed.html">GlFixed</a>* sourceX, <a class="code" href="classGlFixed.html">GlFixed</a>* sourceY,
00262                                           <font class="keywordtype">int</font> rotation, <a class="code" href="classGlFixed.html">GlFixed</a> increment );
00263 
00264 
00265         <font class="comment">/*      Process a particular frame to the stream.</font>
00266 <font class="comment">                @param frame    input: node that describes the frame</font>
00267 <font class="comment">                @param surface  input: the surface where the data is </font>
00268 <font class="comment">                @param rle              output: where to write the frame data</font>
00269 <font class="comment">        */</font>
00270 <font class="comment">//      bool ProcessFrame(      const AllInfo&amp; allInfo,</font>
00271 <font class="comment">//                                              SDL_Surface* surface, </font>
00272 <font class="comment">//                                              KrRle* rle );</font>
00273 
00274         <font class="comment">// Font encoding</font>
00275         <font class="keywordtype">bool</font> EncodeSFontFrames( SDL_Surface* surface, <font class="keyword">const</font> AllInfo&amp; allInfo, <a class="code" href="classKrConsole.html">KrConsole</a>* console );
00276         <font class="keywordtype">bool</font> EncodeFixedFontFrames( SDL_Surface* surface, <font class="keyword">const</font> AllInfo&amp; allInfo, <a class="code" href="classKrConsole.html">KrConsole</a>* console );
00277 
00278         <font class="comment">// Image encoding</font>
00279         <font class="keywordtype">bool</font> EncodeSprite( SDL_Surface* surface, <font class="keyword">const</font> AllInfo&amp; allInfo, <a class="code" href="classKrConsole.html">KrConsole</a>* console );
00280         <font class="keywordtype">bool</font> EncodeFont( SDL_Surface* surface, <font class="keyword">const</font> AllInfo&amp; allInfo, <a class="code" href="classKrConsole.html">KrConsole</a>* console );
00281         <font class="keywordtype">bool</font> EncodeTile( SDL_Surface* surface, <font class="keyword">const</font> AllInfo&amp; allInfo, <a class="code" href="classKrConsole.html">KrConsole</a>* console );
00282 
00283         <font class="comment">// Direct encoding</font>
00284         <font class="keywordtype">bool</font> EncodeColorKey( SDL_Surface* surface, <font class="keyword">const</font> AllInfo&amp; allInfo, <a class="code" href="classKrConsole.html">KrConsole</a>* console );
00285 <font class="comment">//      bool EncodeImage( SDL_Surface* surface, TiXmlElement* e, KrConsole* console );</font>
00286 
00287         <font class="keywordtype">bool</font> EncodeBinary( TiXmlElement* e, <a class="code" href="classKrConsole.html">KrConsole</a>* console );
00288         <font class="keywordtype">bool</font> EncodeText( TiXmlElement* e, <a class="code" href="classKrConsole.html">KrConsole</a>* console );
00289 
00290         <font class="comment">// Printing</font>
00291         <font class="keywordtype">void</font> PrintSprite( <a class="code" href="classKrConsole.html">KrConsole</a>*, <font class="keyword">const</font> std::string&amp; spriteName, <font class="keyword">const</font> std::string&amp; actionName,
00292                                                                   <font class="keywordtype">int</font> frameNum, KrRle* rle );
00293         <font class="keywordtype">void</font> PrintTile(   <a class="code" href="classKrConsole.html">KrConsole</a>*, <font class="keyword">const</font> std::string&amp; tileName, <a class="code" href="classKrTileResource.html">KrTileResource</a>* tile );
00294 
00295         SDL_Surface* LoadSurface( TiXmlElement* definition, std::string* error );
00296 
00297         U32 tagpos;
00298 
00299         <font class="comment">// For storing the 'constant' information used to write the</font>
00300         <font class="comment">// header file.</font>
00301         <font class="keyword">enum</font>
00302         {
00303                 SPRITE,
00304                 TILE,
00305                 ACTION,
00306                 NUM_NAME_BINS,
00307         };
00308 
00309         <font class="keyword">enum</font> 
00310         {
00311                 DEFINITION,
00312                 DIRECT
00313         };
00314 
00315         <font class="keyword">struct </font>Scan
00316         {
00317                 Scan()<font class="keyword">  </font>{ Init(); }
00318                 <font class="keywordtype">void</font> Init()<font class="keyword">             </font>{ x = 0; y = 0; }
00319 
00320                 <font class="keywordtype">int</font> x;
00321                 <font class="keywordtype">int</font> y;
00322         };
00323 
00324         Scan scan;
00325 
00326         <font class="keywordtype">int</font> mode;               <font class="comment">// definiton or direct</font>
00327 
00328         <font class="comment">// Output information.</font>
00329         <font class="keywordtype">int</font> thisLine;
00330         <font class="keywordtype">int</font> nextLine;
00331         <font class="keywordtype">int</font> outputX;
00332         SDL_Surface* output;
00333 
00334         <font class="comment">// Count for information</font>
00335         U32 numRGBA, numLine, numSegment;
00336         U32 numRlePos;  <font class="comment">// position to write count information.</font>
00337 
00338         <a class="code" href="classKrResourceVault.html">KrResourceVault</a> vault;
00339 
00340         KrCachedWrite cachedWrite;
00341         SDL_RWops* stream;
00342 };
00343 
00344 <font class="preprocessor">#endif</font>
00345 <font class="preprocessor"></font>
</pre></div><hr><address><small>Generated on Fri Feb 7 20:44:20 2003 for Kyra by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.11.1 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
