<html><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">

<!--Converted with LaTeX2HTML 2K.1beta (1.48)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>Interfacing to a library of C code</TITLE>
<META NAME="description" CONTENT="Interfacing to a library of C code">
<META NAME="keywords" CONTENT="EiC">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<META NAME="Generator" CONTENT="LaTeX2HTML v2K.1beta">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="EiC.css" tppabs="http://eic.sourceforge.net/documentation/EiC.css">

<LINK REL="next" HREF="node158.html" tppabs="http://eic.sourceforge.net/documentation/node158.html">
<LINK REL="previous" HREF="node156.html" tppabs="http://eic.sourceforge.net/documentation/node156.html">
<LINK REL="up" HREF="node151.html" tppabs="http://eic.sourceforge.net/documentation/node151.html">
<LINK REL="next" HREF="node158.html" tppabs="http://eic.sourceforge.net/documentation/node158.html">
</HEAD>
<body bgcolor="ffffff" text="3e3e64" link="863644" vlink="8e4e5c" alink="8e4e5c">
<!-- StArT-EiC-top-LiNe -->
<table border="0" cellspacing="0" width="100%">
<tr>
<td bgcolor="3e3e64" align="center"><font size="4" color="999999">
#!/usr/bin/eic -f
</td></font>
<td bgcolor="3e3e64" align="center"><font size="3" color="999999">
int main() { printf("Hello World!\n"); return 0; }
</td></font>
<td bgcolor="3e3e64" align="center"><font size="3" color="999999">
EiC 1> Hello World!;
</td></font>
</table>
<!-- EnD-EiC-top-LiNe -->
<blockquote>
<!-- Begin-EiC-logo -->
<img src="logo.gif" tppabs="http://eic.sourceforge.net/images/logo.gif" border="0"><br>  
<!-- End-EiC-logo -->
</blockquote>
<hr size="1" width="93%">
<!-- The master table that contains the left nav bar and the right-side
     page text... -->
<table border="0">
<tr>
   <!-- Begin navbar -->
<td valign="top">
   <a href="javascript:if(confirm('http://eic.sourceforge.net/index.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://eic.sourceforge.net/index.html'" tppabs="http://eic.sourceforge.net/index.html"><img border="0" src="navbar_news.gif" tppabs="http://eic.sourceforge.net/images/navbar_news.gif"></a><br>
   <a href="javascript:if(confirm('http://eic.sourceforge.net/overview/  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://eic.sourceforge.net/overview/'" tppabs="http://eic.sourceforge.net/overview/"><img border="0" src="navbar_overview.gif" tppabs="http://eic.sourceforge.net/images/navbar_overview.gif"></a><br>
   <a href="index.htm" tppabs="http://eic.sourceforge.net/documentation/"><img border="0" src="navbar_documentation.gif" tppabs="http://eic.sourceforge.net/images/navbar_documentation.gif"></a></br>
   <a href="javascript:if(confirm('http://eic.sourceforge.net/download/  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://eic.sourceforge.net/download/'" tppabs="http://eic.sourceforge.net/download/"><img border="0" src="navbar_download.gif" tppabs="http://eic.sourceforge.net/images/navbar_download.gif"></a><br>
   <a href="javascript:if(confirm('http://eic.sourceforge.net/addons/  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://eic.sourceforge.net/addons/'" tppabs="http://eic.sourceforge.net/addons/"><img border="0" src="navbar_addons.gif" tppabs="http://eic.sourceforge.net/images/navbar_addons.gif"></a><br>
   <a href="javascript:if(confirm('http://eic.sourceforge.net/links.html  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://eic.sourceforge.net/links.html'" tppabs="http://eic.sourceforge.net/links.html"><img border="0" src="navbar_links.gif" tppabs="http://eic.sourceforge.net/images/navbar_links.gif"></a><br>
   <a href="javascript:if(confirm('http://eic.sourceforge.net/support/  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://eic.sourceforge.net/support/'" tppabs="http://eic.sourceforge.net/support/"><img border="0" src="navbar_support.gif" tppabs="http://eic.sourceforge.net/images/navbar_support.gif"></a><br>
<br><br>
<!-- Begin sponsors -->
 <font size = "-1"> Sponsors:<br> </font>
 <a href="javascript:if(confirm('http://sourceforge.net/  \n\nThis file was not retrieved by Teleport Pro, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://sourceforge.net/'" tppabs="http://sourceforge.net/"><img src="sflogo.php-group_id=6113&type=4" tppabs="http://sourceforge.net/sflogo.php?group_id=6113&type=4" width="125" height="38" border="0" alt="SourceForge.net Logo"></a> <br>
<!-- End sponsors -->
</td>
   <!-- End navbar -->
   <!-- Begin right-side page data -->
<td valign="top">  <font size="3" face="Helvetica">
<!--Navigation Panel-->
<A NAME="tex2html2745"
  HREF="node158.html" tppabs="http://eic.sourceforge.net/documentation/node158.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png" tppabs="http://eic.sourceforge.net/documentation/next.png"></A> 
<A NAME="tex2html2739"
  HREF="node151.html" tppabs="http://eic.sourceforge.net/documentation/node151.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png" tppabs="http://eic.sourceforge.net/documentation/up.png"></A> 
<A NAME="tex2html2733"
  HREF="node156.html" tppabs="http://eic.sourceforge.net/documentation/node156.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png" tppabs="http://eic.sourceforge.net/documentation/prev.png"></A> 
<A NAME="tex2html2741"
  HREF="node1.html" tppabs="http://eic.sourceforge.net/documentation/node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png" tppabs="http://eic.sourceforge.net/documentation/contents.png"></A> 
<A NAME="tex2html2743"
  HREF="node166.html" tppabs="http://eic.sourceforge.net/documentation/node166.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png" tppabs="http://eic.sourceforge.net/documentation/index.png"></A> 
<BR>
<B> Next:</B> <A NAME="tex2html2746"
  HREF="node158.html" tppabs="http://eic.sourceforge.net/documentation/node158.html">Returning pointers</A>
<B> Up:</B> <A NAME="tex2html2740"
  HREF="node151.html" tppabs="http://eic.sourceforge.net/documentation/node151.html">EiC modules</A>
<B> Previous:</B> <A NAME="tex2html2734"
  HREF="node156.html" tppabs="http://eic.sourceforge.net/documentation/node156.html">Restrictions for builtin functions</A>
 &nbsp <B>  <A NAME="tex2html2742"
  HREF="node1.html" tppabs="http://eic.sourceforge.net/documentation/node1.html">Contents</A></B> 
 &nbsp <B>  <A NAME="tex2html2744"
  HREF="node166.html" tppabs="http://eic.sourceforge.net/documentation/node166.html">Index</A></B> 
<BR>
<BR>
<!--End of Navigation Panel-->

<H2><A NAME="SECTION00716000000000000000"></A>
<A NAME="sec:interface_ccode"></A><A NAME="25483"></A>
<BR>
Interfacing to a library of C code
</H2>

<P>
For the purpose of discussion some example code will be used. First,
the interface between EiC and a library of C code is done via each
library's header file(s). Therefore, the following header file, foo.h,
will be used:

<P>
<PRE>
        1: /* begin header */
        2: 
        3: extern int GVALUE;
        4: 
        5: extern int foo1(int x, int y);
        6: extern int foo2(int z, int (*)(int, int));
        7: extern int * foo3(double (*)());
</PRE>
<P>
This is a simple header file, which is complicated enough to be
interesting and is used to demonstrate several principles only.  On
line 3 there is an external variable that must be shared between the
library being interfaced with and the EiC interpreter. Line 5
represents a straight forward function prototype.  On line 6 is a
little more complicated prototype, as one of the arguments is a
pointer to a function which returns an <B><TT>int</TT></B> and it accepts two
<B><TT>int</TT></B> arguments. The prototype on line 7 is the most complicated in
the example code, as it takes a pointer to a function that receives an
empty parameter list. In C an empty parameter list does not mean that
the function accepts zero aguments; i.e. void. On the contrary, it
means it can accept a variable number of arguments from zero to N. The
only thing that is certain is that arguments cannot be widened -
<B><TT>double</TT></B> instead of <B><TT>float</TT></B>, <B><TT>int</TT></B> instead of <B><TT>short</TT></B> etc.

<P>
Moving to the directory of interest:

<P>
<PRE>
        % cd EiC/module/foo
</PRE>
<P>
Running EiC and from its command line the following lines are entered:

<P>
<PRE>
        EiC &gt; #include foo.h
        EiC &gt; :gen foo.h "foo.c"
</PRE>
<P>
The `:gen' command takes input from `foo.h' and creates an output file
`foo.c', which contains the interfaces.  Note the output file must be
passed to the `:gen' command as a string, and if no output file is
given the interfaces will be written to stdout.

<P>
The first part of file `foo.c' includes several header files:

<P>
<PRE>
        #include &lt;stdlib.h&gt;
        #include &lt;varargs.h&gt;
        #include "eic.h"
        #include "foo.h"
</PRE>
<P>
The varargs.h mechanism is required for passing variable arguments
between compiled C code and EiC, and the header file ``eic.h'' contains
macros and prototypes required to access EiC's runtime stack and
for generating callbacks&nbsp;<A NAME="25498"></A>.

<P>
Next, the interface to `foo1' generated is given:

<P>
<PRE>
        static val_t eic_foo1(void)
        {
                val_t v;
        
                v.ival = foo1(arg(0,getargs(),int),
                        arg(1,getargs(),int));
        
                return v;
        }
</PRE>
<P>
This is the simplest interface, it essentially just collects the
arguments passed on EiC's stack, via the `arg' facililty defined in the
header file ``eic.h'', passes these values to the function ``foo1''
and it returns the return value, packaged in the union `v'
to EiC.

<P>
This is then followed by the interface to `foo2':

<P>
<PRE>
        static void * EiC_Cfunc_0 = NULL;
        static int  MiddleOne_0(int  x0, int  x1)
        {
            setArg(0, EiC_Cfunc_0, int ,x0);
            setArg(1, EiC_Cfunc_0, int ,x1);
        
            EiC_callBack(EiC_Cfunc_0);
            return EiC_ReturnValue( int );
        }
        
        static val_t eic_foo2(void)
        {
                val_t v;
        
                EiC_Cfunc_0 = arg(1,getargs(),ptr_t).p;
                v.ival = foo2(arg(0,getargs(),int),
                        MiddleOne_0);
        
                return v;
        }
</PRE>
<P>
The interface to `foo2' is more complex and requirs two functions.  At
compile time, EiC creates the callback&nbsp;<A NAME="25503"></A> code for the function being
passed. The callback codes gets substituted for the pointer to the
function and a reference to it will be stored in EiC_Cfunc_0 and when
the interface routine `eic_foo2' is called.

<P>
Within `eic_foo2' the compiled function foo2 is called, passing it a
pointer to the proxy function `MiddleOne_0'. The roll of `MiddleOne_0'
is to collect the arguments being passed from `foo2' for the
interpreter'd function pointered to by `EiC_Cfunc_0', and to return
the return value back to `foo2'. `MiddleOne_0' uses EiC's setArg
facility defined in `eic.h' for passing values from the machines
runtime stack to the EiC interpreter'd function (and it makes no
difference if the interpreter'd function being callback is actually
another builtin function). The EiC_ReturnValue( type ) macro gets the
last value stored on EiC's runtime stack and casts it to `type', and it
is this value that gets returned to its caller. 

<P>
This all occurs seamlessly to the user; for  example:

<P>
<PRE>
        EiC &gt; int f(int x, int y) { return x + y;}
        EiC &gt; foo2(5,f);
</PRE>
<P>
On line 7 is the prototype for `foo3' is given:

<P>
<PRE>
        7: extern int * foo3(double (*)());
</PRE>
<P>
The `foo3' function is the most complex funtion in the example code to
interface to. This is because `foo3' receives a pointer to a function,
to which inturn accepts a variable number of arguments and it also
returns a pointer, adding another degree of complexity to the
interface. The default interface generated will be:

<P>
<PRE>
        static void * EiC_Cfunc_1 = NULL;
        static double  MiddleOne_1( va_alist )  va_dcl
        {
            void Auto_EiC_CallBack(code_t *callback, va_list ap);
            va_list ap; va_start(ap);
            Auto_EiC_CallBack(EiC_Cfunc_1,ap);
        
            EiC_callBack(EiC_Cfunc_1);
            return EiC_ReturnValue( double );
            va_end(ap);
        }
        
        static val_t eic_foo3(void)
        {
                val_t v;
        
                EiC_Cfunc_1 = arg(0,getargs(),ptr_t).p;
                v.p.ep = v.p.sp = v.p.p = foo3(MiddleOne_1);
        
                return v;
        }
</PRE>
<P>
This interface works essentially the same way as that for `foo2'. The
main differences being that the proxy function `MiddleOne_1' uses the
Unix varargs mechanism for passing variable arguments. However, rather
than using the `setArg' mechanism, the function `Auto_EiC_callBack'
is used to get the variable(s) to be passed to the callback function.

<P>
<HR>
<!--Navigation Panel-->
<A NAME="tex2html2745"
  HREF="node158.html" tppabs="http://eic.sourceforge.net/documentation/node158.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.png" tppabs="http://eic.sourceforge.net/documentation/next.png"></A> 
<A NAME="tex2html2739"
  HREF="node151.html" tppabs="http://eic.sourceforge.net/documentation/node151.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.png" tppabs="http://eic.sourceforge.net/documentation/up.png"></A> 
<A NAME="tex2html2733"
  HREF="node156.html" tppabs="http://eic.sourceforge.net/documentation/node156.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.png" tppabs="http://eic.sourceforge.net/documentation/prev.png"></A> 
<A NAME="tex2html2741"
  HREF="node1.html" tppabs="http://eic.sourceforge.net/documentation/node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.png" tppabs="http://eic.sourceforge.net/documentation/contents.png"></A> 
<A NAME="tex2html2743"
  HREF="node166.html" tppabs="http://eic.sourceforge.net/documentation/node166.html">
<IMG WIDTH="43" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="index" SRC="index.png" tppabs="http://eic.sourceforge.net/documentation/index.png"></A> 
<BR>
<B> Next:</B> <A NAME="tex2html2746"
  HREF="node158.html" tppabs="http://eic.sourceforge.net/documentation/node158.html">Returning pointers</A>
<B> Up:</B> <A NAME="tex2html2740"
  HREF="node151.html" tppabs="http://eic.sourceforge.net/documentation/node151.html">EiC modules</A>
<B> Previous:</B> <A NAME="tex2html2734"
  HREF="node156.html" tppabs="http://eic.sourceforge.net/documentation/node156.html">Restrictions for builtin functions</A>
 &nbsp <B>  <A NAME="tex2html2742"
  HREF="node1.html" tppabs="http://eic.sourceforge.net/documentation/node1.html">Contents</A></B> 
 &nbsp <B>  <A NAME="tex2html2744"
  HREF="node166.html" tppabs="http://eic.sourceforge.net/documentation/node166.html">Index</A></B> 
<!--End of Navigation Panel-->
<ADDRESS>
</td> <!-- End right-side page text -->
</tr> 
</table>
<!-- End master table -->
</ADDRESS>
</BODY>
</HTML>
